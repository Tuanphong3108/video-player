<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- T·∫£i Material Symbols (Outline, Fill, Weight) - FIXED: D√πng display=swap ƒë·ªÉ ƒë·∫£m b·∫£o font load ·ªïn ƒë·ªãnh h∆°n -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" />
    
    <!-- === PWA MANIFEST & FILE HANDLING === -->
    <meta name="theme-color" content="#1c1b1f"> 
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* Thi·∫øt l·∫≠p font Inter cho to√†n b·ªô ·ª©ng d·ª•ng */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* T·ªëi ∆∞u thanh cu·ªôn */
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #2d3748;
        }
        /* Styling cho thanh Range Slider (Ti·∫øn tr√¨nh) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #3b82f6; /* accent */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #3b82f6; /* accent */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
            border: none;
        }

        /* Animation cho Drag & Drop Overlay */
        #drag-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        /* --- FIX ASPECT RATIO CSS (D√πng Padding-Bottom Hack) --- */
        .aspect-ratio-box {
            position: relative;
            width: 100%;
            /* Chi·ªÅu cao ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a b·ªüi padding-bottom (t·ªâ l·ªá), g√°n t·ª´ JS */
            padding-bottom: var(--video-ratio, 56.25%); /* Fallback 16:9 (9/16 * 100) */
            height: 0; /* ƒê·∫£m b·∫£o padding-bottom x√°c ƒë·ªãnh chi·ªÅu cao */
            /* QUAN TR·ªåNG: Gi·ªõi h·∫°n chi·ªÅu cao tuy·ªát ƒë·ªëi c·ªßa box ƒë·ªÉ kh√¥ng v∆∞·ª£t qu√° t·∫ßm nh√¨n, gi√∫p controls kh√¥ng b·ªã cu·ªôn */
            max-height: calc(100vh - 180px); /* Kho·∫£ng 180px cho header, padding v√† margin */
            overflow: hidden; 
        }
        /* Media content (video, iframe) n·∫±m tuy·ªát ƒë·ªëi b√™n trong container gi·ªØ t·ªâ l·ªá */
        .aspect-ratio-box #videoPlayer, 
        .aspect-ratio-box .media-iframe { /* D√πng class chung cho iframe */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; 
        }
        /* Controls Overlay c·∫ßn n·∫±m tuy·ªát ƒë·ªëi v√† ch·ªâ √°p d·ª•ng khi custom controls ƒë∆∞·ª£c d√πng */
        .aspect-ratio-box #controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; 
            flex-direction: column;
            justify-content: flex-end;
            pointer-events: none;
        }
        
        /* --- MATERIAL SYMBOLS STYLING --- */
        .material-symbols-outlined {
            /* ƒê·∫£m b·∫£o tr√¨nh duy·ªát bi·∫øt d√πng font n√†y khi load */
            font-family: 'Material Symbols Outlined';
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            transition: font-variation-settings 0.3s ease; 
            line-height: 1; 
            display: inline-block;
            /* Ph·∫£i c√≥ ƒë·ªÉ hi·ªÉn th·ªã icon thay v√¨ ch·ªØ */
            font-feature-settings: 'liga'; 
            -webkit-font-feature-settings: 'liga';
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }
        
        .group:hover .material-symbols-outlined,
        .group:focus-visible .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 600, 'GRAD' 0, 'opsz' 24;
        }

        /* --- CUSTOM TOOLTIP STYLING --- */
        #customTooltip {
            position: fixed; 
            z-index: 60; 
            padding: 4px 8px;
            background-color: rgba(43, 43, 43, 0.9); 
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none; 
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px); 
            white-space: nowrap;
        }
        .tooltip-visible {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        /* Styling cho Data Row trong Modal */
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #374151; /* card-dark */
        }
        .data-row:last-child {
            border-bottom: none;
        }
    </style>
    <script>
        // C·∫•u h√¨nh Tailwind CSS: B·∫≠t dark mode v√† m√†u s·∫Øc c∆° b·∫£n
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'background-dark': '#1f2937', // Grey 800
                        'card-dark': '#374151',      // Grey 700
                        'accent': '#3b82f6',         // Blue 500
                        'warning': '#f59e0b',        // Amber 500
                        'danger': '#ef4444',         // Red 500
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-4 bg-gray-800 shadow-lg flex justify-between items-center z-10">
        <!-- Title and Video Info -->
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-white">Video Player üé•</h1>
            <!-- V·ªã tr√≠ m·ªõi cho th√¥ng tin video -->
            <div id="currentVideoInfo" class="text-xs text-gray-400 mt-1">S·∫µn s√†ng nh·∫≠n l·ªánh...</div>
        </div>

        <!-- Right Buttons: File Actions and Select File -->
        <div class="flex items-center space-x-3">
            
            <!-- Group: File Actions (Share, Info, Delete) - Ch·ªâ hi·ªán khi c√≥ file local -->
            <div id="fileActionsGroup" class="flex items-center space-x-2 bg-gray-700 p-1 rounded-lg shadow-inner hidden">
                
                <!-- Info Button (D√πng cho local file) -->
                <button id="infoBtn" title="Th√¥ng tin chi ti·∫øt t·ªáp" class="group p-2 text-gray-300 hover:text-white rounded-lg transition duration-150 transform hover:scale-105" onclick="showFileInfoModal()">
                    <span class="material-symbols-outlined text-xl">info</span>
                </button>
                
                <!-- Share Button -->
                <button id="shareBtn" title="Chia s·∫ª t·ªáp g·ªëc" class="group p-2 text-gray-300 hover:text-green-400 rounded-lg transition duration-150 transform hover:scale-105">
                    <span class="material-symbols-outlined text-xl">share</span>
                </button>
                
                <!-- Delete Button (B·ªä ·∫®N Vƒ®NH VI·ªÑN DO GI·ªöI H·∫†N WEB API) -->
                <button id="deleteBtn" title="H·∫°n ch·∫ø Web API: X√≥a t·ªáp kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ qua File Handle" class="group p-2 text-gray-300 hover:text-danger rounded-lg transition duration-150 transform hover:scale-105 hidden" onclick="showApiLimitationMessage()">
                    <span class="material-symbols-outlined text-xl">delete</span>
                </button>

            </div>
            
            <!-- N√∫t Ch·ªçn Video -->
            <button id="selectFileBtn" title="Ch·ªçn video b·∫±ng File System Access API ho·∫∑c Link" onclick="handleFilePicker()" class="group cursor-pointer bg-accent hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 flex items-center space-x-2">
                <span class="material-symbols-outlined text-xl">upload_file</span>
                <span>Ch·ªçn Ngu·ªìn</span>
            </button>
            
            <!-- Hidden input for old-school fallback and PWA file launching -->
            <input type="file" id="fileInputFallback" accept="video/*" class="hidden" onchange="handleFileSelectFallback(event)">
        </div>
    </header>

    <!-- Main Content Area - Video Player takes full width -->
    <main class="flex-grow flex flex-col overflow-hidden">
        
        <!-- C·∫£nh b√°o d√†nh ri√™ng cho m√¥i tr∆∞·ªùng Canvas/Iframe (L·ªói 153) -->
        <div id="youtubeWarning" class="p-2 bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-300 hidden transition-all duration-300">
            <div class="flex items-center space-x-3 max-w-7xl mx-auto">
                <span class="material-symbols-outlined text-2xl flex-shrink-0">security</span>
                <p class="text-sm font-medium">
                    <b>C·∫¢NH B√ÅO:</b> Ph√°t link YouTube c√≥ th·ªÉ b·ªã ch·∫∑n (L·ªói 153) trong m√¥i tr∆∞·ªùng <b>Canvas/Iframe</b> do ch√≠nh s√°ch b·∫£o m·∫≠t qu√° nghi√™m ng·∫∑t. Vui l√≤ng th·ª≠ l·∫°i tr√™n tr√¨nh duy·ªát <b>ngo√†i m√¥i tr∆∞·ªùng n√†y</b> n·∫øu video kh√¥ng load.
                </p>
            </div>
        </div>
        
        <!-- Video Player Area (Container) -->
        <div id="video-container" class="w-full p-4 flex flex-col items-center justify-center bg-background-dark relative flex-grow">

            <!-- Video Wrapper (Khung ch·ª©a video, d√πng ƒë·ªÉ gi·ªØ t·ªâ l·ªá v√† √°p d·ª•ng gi·ªõi h·∫°n chi·ªÅu r·ªông) -->
            <div id="video-wrapper" class="w-full rounded-xl shadow-2xl bg-black border border-gray-700 relative overflow-hidden hidden aspect-ratio-box">
                
                <!-- KH√îNG C√ì N√öT INFO N·ªîI CHO EMBED N·ªÆA -->
                
                <!-- Video Player (Ch·ªâ d√πng cho local file) -->
                <video id="videoPlayer"></video>
                
                <!-- Iframes ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y (s·∫Ω d√πng class media-iframe) -->

                <!-- Custom Controls Overlay (Ch·ªâ d√πng cho local file, b·ªã ·∫©n khi d√πng YouTube) -->
                <div id="controls-overlay" class="transition-opacity duration-300 opacity-0 pointer-events-none p-4">
                    <div id="customControls" class="w-full bg-gray-900/90 backdrop-blur-sm p-3 rounded-xl shadow-2xl border border-gray-700 flex flex-col pointer-events-auto">
                        
                        <!-- Seek Bar / Progress Bar -->
                        <input type="range" id="progressBar" value="0" min="0" max="100" class="w-full h-1 appearance-none cursor-pointer bg-accent/50 rounded-full">

                        <!-- Control Buttons Row -->
                        <div class="flex items-center justify-between mt-2">
                            
                            <!-- Left Controls: Play/Skip/Time -->
                            <div class="flex items-center space-x-3">
                                
                                <!-- Skip Backward 10s -->
                                <button id="skipBackwardBtn" title="Tua l√πi 10s" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 transform hover:scale-110 group">
                                    <span class="material-symbols-outlined text-2xl">replay_10</span>
                                </button>
                                
                                <!-- Play/Pause Button -->
                                <button id="playPauseBtn" title="Play/Pause" class="p-2 text-white bg-accent hover:bg-blue-600 rounded-full transition duration-150 transform hover:scale-110 group">
                                    <span id="playPauseIcon" class="material-symbols-outlined text-3xl">play_arrow</span>
                                </button>
                                
                                <!-- Skip Forward 10s -->
                                <button id="skipForwardBtn" title="Tua ti·∫øn 10s" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 transform hover:scale-110 group">
                                    <span class="material-symbols-outlined text-2xl">forward_10</span>
                                </button>

                                <!-- Time Display -->
                                <div id="timeDisplay" class="text-sm font-mono text-gray-300 hidden md:block">00:00 / 00:00</div>
                            </div>

                            <!-- Right Controls: Speed, Loop, Cast, PiP, Volume, Fullscreen -->
                            <div class="flex items-center space-x-3">
                                
                                <!-- Speed Control -->
                                <div class="relative group">
                                    <button id="speedBtn" title="T·ªëc ƒë·ªô ph√°t" class="p-2 text-gray-300 hover:text-white rounded-lg text-sm font-semibold transition duration-150 bg-gray-800/50">
                                        1.0x
                                    </button>
                                    <!-- Speed Menu -->
                                    <div id="speedMenu" class="absolute bottom-full mb-2 right-0 bg-gray-900 border border-gray-700 rounded-lg shadow-xl overflow-hidden hidden w-20">
                                    </div>
                                </div>
                                
                                <!-- Loop Button -->
                                <button id="loopBtn" title="L·∫∑p l·∫°i" class="p-2 text-gray-500 hover:text-accent rounded-full transition duration-150 group">
                                    <span class="material-symbols-outlined text-xl">repeat</span>
                                </button>

                                <!-- Picture-in-Picture Button (PiP) -->
                                <button id="pipBtn" title="H√¨nh trong h√¨nh (PiP)" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 group">
                                    <span class="material-symbols-outlined text-xl">picture_in_picture_alt</span>
                                </button>
                                
                                <!-- Volume Control (Hi·ªán Slider khi hover) -->
                                <div class="flex items-center space-x-2 group relative">
                                    <!-- Volume Slider (kh√¥ng c·∫ßn tooltip) -->
                                    <input type="range" id="volumeSlider" value="100" min="0" max="100" title="√Çm l∆∞·ª£ng" class="w-20 h-1 appearance-none cursor-pointer bg-gray-700 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 hidden md:block">
                                    <!-- Volume Button -->
                                    <button id="volumeBtn" title="T·∫Øt/M·ªü ti·∫øng" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 group">
                                        <span id="volumeIcon" class="material-symbols-outlined text-xl">volume_up</span>
                                    </button>
                                </div>

                                <!-- Fullscreen Button -->
                                <button id="fullscreenBtn" title="To√†n m√†n h√¨nh" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 group">
                                    <span id="fullscreenIcon" class="material-symbols-outlined text-xl">fullscreen</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Custom Controls Overlay -->
            </div>
            <!-- End Video Wrapper -->
            
            <div id="placeholder" class="text-center text-gray-400 p-8 rounded-xl border-2 border-dashed border-gray-700 bg-gray-800 transition duration-300 flex flex-col items-center justify-center w-full max-w-lg h-64">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <p class="text-lg font-medium">K√©o & Th·∫£ Video Ho·∫∑c</p>
                <p class="text-sm mt-1">Nh·∫•n "Ch·ªçn Ngu·ªìn" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                <p class="text-xs mt-3 text-yellow-400">üö® ƒê·ªÉ M·ªü File Tr·ª±c Ti·∫øp: C√†i ƒë·∫∑t ·ª©ng d·ª•ng PWA n√†y qua tr√¨nh duy·ªát!</p>
            </div>
        </div>
        
        <!-- CUSTOM TOOLTIP DIV (D√πng position: fixed) -->
        <div id="customTooltip" class="hidden"></div>

        <!-- MODAL 1: Ch·ªçn Ngu·ªìn Video -->
        <div id="fileSourceModal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-40 flex items-center justify-center hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-white">Ch·ªçn Ngu·ªìn Video</h2>
                
                <!-- Tab 1: T·∫£i L√™n Video -->
                <div id="tabUpload" class="border border-dashed border-gray-700 p-4 rounded-lg mb-4 text-center hover:bg-gray-700/50 transition cursor-pointer" onclick="handleLocalFileSelection()">
                    <span class="material-symbols-outlined text-4xl text-accent mx-auto block mb-2">video_library</span>
                    <p class="font-semibold text-lg">T·∫£i L√™n Video (T·ªáp c·ª•c b·ªô)</p>
                    <p class="text-sm text-gray-400">Ch·ªçn t·ªáp MP4, MOV t·ª´ m√°y t√≠nh (c√≥ quy·ªÅn ch·ªânh s·ª≠a n·∫øu d√πng FSSA).</p>
                </div>

                <div class="flex items-center my-4">
                    <div class="flex-grow border-t border-gray-700"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-sm font-medium">HO·∫∂C</span>
                    <div class="flex-grow border-t border-gray-700"></div>
                </div>

                <!-- Tab 2: Nh·∫≠p Link -->
                <div>
                    <label for="videoLinkInput" class="block text-sm font-medium text-gray-300 mb-2">Nh·∫≠p Link Video (Ch·ªâ h·ªó tr·ª£ YouTube Embed)</label>
                    <input type="text" id="videoLinkInput" placeholder="V√≠ d·ª•: https://www.youtube.com/watch?v=..." class="w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-accent focus:border-accent">
                    
                    <button id="loadLinkBtn" onclick="handleLinkInput()" class="group w-full mt-3 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg shadow-md transition duration-300 transform hover:scale-[1.01] flex items-center justify-center space-x-2">
                        <span class="material-symbols-outlined text-xl">link</span>
                        <span>T·∫£i t·ª´ Link</span>
                    </button>
                    
                    <!-- V√πng hi·ªÉn th·ªã l·ªói/c·∫£nh b√°o -->
                    <div id="linkError" class="text-sm text-red-400 mt-2 hidden flex items-center space-x-1">
                        <span class="material-symbols-outlined text-base">warning</span>
                        <span id="linkErrorText"></span>
                    </div>
                </div>
                
                <button onclick="hideModal('fileSourceModal')" class="mt-4 text-gray-400 hover:text-white transition w-full">H·ªßy</button>
            </div>
        </div>
        <!-- END MODAL 1: File Source Modal -->

        <!-- MODAL 2: Th√¥ng tin File (CH·ªà D√ôNG CHO LOCAL FILE) -->
        <div id="fileInfoModal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-40 flex items-center justify-center hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-white flex items-center space-x-2">
                    <span class="material-symbols-outlined">description</span>
                    <span>Th√¥ng tin T·ªáp C·ª•c B·ªô</span>
                </h2>
                <div class="space-y-2 text-gray-300" id="fileInfoContent">
                    <!-- N·ªôi dung th√¥ng tin chi ti·∫øt s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JS -->
                </div>
                <button onclick="hideModal('fileInfoModal')" class="mt-6 w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 rounded-lg transition duration-300">ƒê√≥ng</button>
            </div>
        </div>
        <!-- END MODAL 2: File Info Modal -->
        
        <!-- MODAL 3: C·∫£nh b√°o Quy·ªÅn Truy C·∫≠p -->
        <div id="permissionRequiredModal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-40 flex items-center justify-center hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-white flex items-center space-x-2">
                    <span class="material-symbols-outlined text-warning text-3xl">info</span>
                    <span>C·∫ßn c√≥ quy·ªÅn ƒê·ªçc & Ghi</span>
                </h2>
                <p class="text-gray-300 mb-6">Hi·ªán t·∫°i t·ªáp ƒëang ·ªü "Ch·ªâ ƒë·ªçc". Vui l√≤ng t·∫£i l√™n t·ªáp v·ªõi quy·ªÅn "ƒê·ªçc & Ghi" (b·∫±ng c√°ch d√πng n√∫t <b>Ch·ªçn Ngu·ªìn</b> > <b>T·∫£i L√™n Video</b>) ƒë·ªÉ c√≥ th·ªÉ chia s·∫ª t·ªáp g·ªëc qua h·ªá th·ªëng chia s·∫ª c·ªßa tr√¨nh duy·ªát.</p>
                <button onclick="hideModal('permissionRequiredModal')" class="mt-4 w-full bg-accent hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-300">OK</button>
            </div>
        </div>
        <!-- END MODAL 3: C·∫£nh b√°o Quy·ªÅn Truy C·∫≠p -->

    </main>
    
    <!-- Drag & Drop Visual Overlay -->
    <div id="drag-overlay" class="fixed inset-0 bg-accent/30 backdrop-blur-sm z-50 pointer-events-none opacity-0 flex items-center justify-center border-4 border-dashed border-accent rounded-xl m-4">
        <p class="text-3xl font-bold text-white shadow-lg p-4 bg-accent/70 rounded-lg">TH·∫¢ VIDEO V√ÄO ƒê√ÇY</p>
    </div>

    <script>
        // Global variables
        const videoPlayer = document.getElementById('videoPlayer');
        const placeholder = document.getElementById('placeholder');
        const currentVideoInfo = document.getElementById('currentVideoInfo');
        const videoWrapper = document.getElementById('video-wrapper');
        const controlsOverlay = document.getElementById('controls-overlay');
        const dragOverlay = document.getElementById('drag-overlay');
        const shareBtn = document.getElementById('shareBtn'); 
        const deleteBtn = document.getElementById('deleteBtn'); 
        const fileActionsGroup = document.getElementById('fileActionsGroup'); 
        const fileInputFallback = document.getElementById('fileInputFallback'); 
        const customTooltip = document.getElementById('customTooltip'); 
        const youtubeWarning = document.getElementById('youtubeWarning'); 
        const pipBtn = document.getElementById('pipBtn'); 
     
        // Modal elements
        const fileSourceModal = document.getElementById('fileSourceModal');
        const fileInfoModal = document.getElementById('fileInfoModal');
        const permissionRequiredModal = document.getElementById('permissionRequiredModal'); 
        const videoLinkInput = document.getElementById('videoLinkInput');
        const linkError = document.getElementById('linkError');
        const linkErrorText = document.getElementById('linkErrorText');


        // Global State 
        let currentFileURL = null; 
        let currentFileName = null;
        let currentFileHandle = null; 
        let currentFileDetails = null; 
        let controlsTimeout;
        const defaultPlaybackRate = 1.0;
        
        // NEW STATES
        let isYouTubeEmbed = false; 
        let mediaIframe = null; 
        
        // --- UTILITY FUNCTIONS ---

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainderSeconds = Math.floor(seconds % 60);
            const paddedMinutes = String(minutes).padStart(2, '0');
            const paddedSeconds = String(remainderSeconds).padStart(2, '0');
            return `${paddedMinutes}:${paddedSeconds}`;
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function showControls() {
            if (isYouTubeEmbed) return; 
            if (controlsOverlay.classList.contains('hidden')) return;
            if (videoWrapper.classList.contains('hidden')) return;
            
            controlsOverlay.classList.remove('opacity-0');
            clearTimeout(controlsTimeout);
            
            if (!videoPlayer.paused) {
                controlsTimeout = setTimeout(() => {
                    controlsOverlay.classList.add('opacity-0');
                }, 3000);
            }
        }

        function hideControls() {
            if (isYouTubeEmbed) return; 
            if (controlsOverlay.classList.contains('hidden')) return;
            clearTimeout(controlsTimeout);
            controlsOverlay.classList.add('opacity-0');
        }

        /**
         * C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t Share, Info.
         */
        function updateFileActionsState() {
            // N√∫t Delete lu√¥n ·∫©n v√¨ Web API kh√¥ng h·ªó tr·ª£ x√≥a file qua FileHandle (ch·ªâ qua DirectoryHandle).
            deleteBtn.classList.add('hidden'); 

            if (isYouTubeEmbed || !currentFileName) {
                fileActionsGroup.classList.add('hidden');
            } else {
                // Ch·ªâ hi·ªán group cho Local File
                fileActionsGroup.classList.remove('hidden');
                
                // N√∫t Share lu√¥n hi·ªán n·∫øu l√† file local
                shareBtn.classList.remove('hidden'); 
                
                if (currentFileHandle) {
                    shareBtn.title = "Chia s·∫ª t·ªáp g·ªëc (C√≥ quy·ªÅn truy c·∫≠p ƒê·ªçc/Ghi)";
                    shareBtn.classList.remove('text-red-400');
                    shareBtn.classList.add('hover:text-green-400');
                } else {
                    shareBtn.title = "Chia s·∫ª b·ªã ch·∫∑n. B·∫•m ƒë·ªÉ xem t·∫°i sao.";
                    shareBtn.classList.remove('hover:text-green-400');
                    shareBtn.classList.add('hover:text-red-400');
                }
            }
        }
        
        // --- MEDIA PLAYER SWITCHING LOGIC ---

        /**
         * H√†m reset v·ªÅ tr·∫°ng th√°i media player local.
         */
        function resetMediaPlayer(resetFileHandle = true) {
            isYouTubeEmbed = false;
            youtubeWarning.classList.add('hidden'); 

            // 1. D·ªçn d·∫πp iframe 
            if (mediaIframe && videoWrapper.contains(mediaIframe)) {
                videoWrapper.removeChild(mediaIframe);
                mediaIframe = null;
            }
            
            // 2. Clear local video source (ƒë·ªÉ d·ª´ng ph√°t)
            videoPlayer.pause();
            if (currentFileURL) {
                URL.revokeObjectURL(currentFileURL);
                currentFileURL = null;
            }
            videoPlayer.removeAttribute('src');
            
            // 3. Hi·ªán c√°c ph·∫ßn t·ª≠ local v√† controls
            videoPlayer.classList.remove('hidden');
            controlsOverlay.classList.remove('hidden');
            controlsOverlay.classList.add('opacity-0'); 
            
            // 4. Reset File Handle/Details n·∫øu c·∫ßn
            if (resetFileHandle) {
                currentFileHandle = null; 
                currentFileDetails = null;
            }
            
            // 5. C·∫≠p nh·∫≠t UI state
            document.getElementById('playPauseIcon').textContent = 'play_arrow'; 
            currentVideoInfo.textContent = 'S·∫µn s√†ng nh·∫≠n l·ªánh...';
            currentFileName = null;
            
            // 6. ƒê·∫£m b·∫£o aspect ratio v√† layout default
            videoWrapper.classList.add('aspect-ratio-box');
            
            // 7. ·∫®n wrapper n·∫øu kh√¥ng c√≥ n·ªôi dung
            videoWrapper.classList.add('hidden');
            placeholder.classList.remove('hidden');
            
            // Quan tr·ªçng: X√≥a Media Session Handlers
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = null;
                // Ch·ªâ x√≥a handlers, kh√¥ng x√≥a n√∫t
                navigator.mediaSession.setActionHandler('play', null);
                navigator.mediaSession.setActionHandler('pause', null);
                navigator.mediaSession.setActionHandler('seekbackward', null);
                navigator.mediaSession.setActionHandler('seekforward', null);
            }
            
            updateFileActionsState();
        }

        /**
         * T·∫£i v√† b·∫Øt ƒë·∫ßu ph√°t video t·ª´ File object.
         */
        function loadVideoFromFile(file) {
            // KH√îNG RESET currentFileHandle ·ªü ƒë√¢y, v√¨ n√≥ ƒë√£ ƒë∆∞·ª£c set/reset ·ªü FSSA/Fallback logic
            resetMediaPlayer(false); 
            
            const objectURL = URL.createObjectURL(file);
            currentFileURL = objectURL;
            currentFileName = file.name;
            currentFileDetails = file; // L∆∞u chi ti·∫øt File object
            videoPlayer.src = currentFileURL;
            videoPlayer.load();

            // Reset t·ªëc ƒë·ªô ph√°t v√† c·∫≠p nh·∫≠t giao di·ªán
            videoPlayer.playbackRate = defaultPlaybackRate;
            document.getElementById('speedBtn').textContent = `${defaultPlaybackRate.toFixed(1)}x`;

            // C·∫≠p nh·∫≠t giao di·ªán: ·∫®n placeholder, hi·ªán video wrapper
            placeholder.classList.add('hidden');
            videoWrapper.classList.remove('hidden');
            
            videoPlayer.play().catch(e => {
                console.warn("L·ªói t·ª± ƒë·ªông ph√°t: " + e.message);
                currentVideoInfo.textContent = `‚ñ∂Ô∏è ƒê√£ t·∫£i: ${file.name}. Vui l√≤ng nh·∫•n n√∫t Play.`;
                showControls();
            });
            
            updateFileActionsState();
        }
        
        // --- MODAL LOGIC ---
        
        // H√†m show modal chung
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
        
        // H√†m hide modal chung
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function handleFilePicker() {
            showModal('fileSourceModal');
            linkError.classList.add('hidden');
            linkErrorText.textContent = '';
            videoLinkInput.value = '';
            videoLinkInput.placeholder = "V√≠ d·ª•: https://www.youtube.com/watch?v=...";
        }

        // --- FILE PICKER & LINK LOGIC ---

        /**
         * Logic ch·ªçn file c·ª•c b·ªô (T√°ch ra t·ª´ handleFilePicker c≈©)
         */
        async function handleLocalFileSelection() {
            hideModal('fileSourceModal'); 
            
            if (!window.showOpenFilePicker) {
                currentVideoInfo.textContent = 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ FSSA. M·ªü h·ªôp tho·∫°i file truy·ªÅn th·ªëng...';
                fileInputFallback.click(); 
                return;
            }

            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'Video Files',
                        accept: { 'video/*': ['.mp4', '.mov', '.webm', '.mkv', '.ogg', '.avi'] }
                    }],
                    multiple: false,
                    mode: 'readwrite' 
                });

                // Lu√¥n c·∫≠p nh·∫≠t File Handle m·ªõi
                currentFileHandle = fileHandle; 
                const file = await fileHandle.getFile();
                
                loadVideoFromFile(file);
                currentVideoInfo.textContent = `‚úÖ ƒê√£ c·∫•p quy·ªÅn ch·ªânh s·ª≠a cho: ${file.name}`;

            } catch (err) {
                if (err.name === 'AbortError') {
                    currentVideoInfo.textContent = 'Ch·ªçn t·ªáp b·ªã h·ªßy.';
                } else {
                    console.error('L·ªói File System Access API:', err);
                    // D√ôNG FALLBACK -> KH√îNG C√ì HANDLE
                    currentFileHandle = null; 
                    currentVideoInfo.textContent = '‚ùå L·ªói FSSA. ƒêang chuy·ªÉn sang ch·ªçn file truy·ªÅn th·ªëng...';
                    fileInputFallback.click(); 
                }
                updateFileActionsState();
            }
        }

        /**
         * Fallback cho input[type=file] (ch·ªâ quy·ªÅn ƒë·ªçc)
         */
        function handleFileSelectFallback(event) {
            const files = event.target.files;
            if (files.length > 0) {
                currentFileHandle = null; // Lu√¥n reset khi d√πng Fallback
                loadVideoFromFile(files[0]);
                currentVideoInfo.textContent = `‚ö†Ô∏è ƒê√£ t·∫£i file: ${files[0].name} (ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc).`;
            }
        }
        
        /**
         * Helper: Tr√≠ch xu·∫•t YouTube ID
         */
        function getYoutubeVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\/|watch\?v=))([^&]+)|(?:youtu\.be\/)([^&?]+)|(?:youtube\.com\/shorts\/)([^&?]+)/;
            const match = url.match(regex);
            if (match) {
                return match[1] || match[2] || match[3];
            }
            return null;
        }

        /**
         * X·ª≠ l√Ω ƒë·∫ßu v√†o Link
         */
        function handleLinkInput() {
            const url = videoLinkInput.value.trim();
            linkError.classList.add('hidden');

            if (!url) {
                linkErrorText.textContent = "Vui l√≤ng nh·∫≠p link video.";
                linkError.classList.remove('hidden');
                return;
            }
            
            const videoId = getYoutubeVideoId(url);
            
            if (videoId) {
                hideModal('fileSourceModal');
                loadYouTubeEmbed(videoId);
            } else {
                linkErrorText.textContent = "Hi·ªán t·∫°i ·ª©ng d·ª•ng ch·ªâ h·ªó tr·ª£ link YouTube Embed h·ª£p l·ªá.";
                linkError.classList.remove('hidden');
            }
        }

        /**
         * Chuy·ªÉn sang ch·∫ø ƒë·ªô YouTube Embed (Ph√°t)
         */
        function loadYouTubeEmbed(videoId) {
            // Reset state, bao g·ªìm c·∫£ currentFileHandle
            resetMediaPlayer(true); 
            isYouTubeEmbed = true;
            currentFileName = `YouTube: ${videoId}`;

            youtubeWarning.classList.remove('hidden');
            
            videoPlayer.classList.add('hidden');
            controlsOverlay.classList.add('hidden');
            placeholder.classList.add('hidden');
            videoWrapper.classList.remove('hidden');
            
            // Thi·∫øt l·∫≠p ASPECT RATIO 16:9 M·∫∂C ƒê·ªäNH CHO YOUTUBE EMBED
            videoWrapper.classList.add('aspect-ratio-box');
            videoWrapper.style.setProperty('--video-ratio', `56.25%`); // 16:9
            
            // T·∫°o v√† ch√®n Iframe
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&modestbranding=1&rel=0&showinfo=0`;
            
            mediaIframe = document.createElement('iframe');
            mediaIframe.id = 'youtubeEmbed';
            mediaIframe.src = embedUrl;
            mediaIframe.frameBorder = '0';
            
            mediaIframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture; web-share; clipboard-write; fullscreen');
            mediaIframe.setAttribute('allowfullscreen', 'true'); 
            
            mediaIframe.className = 'media-iframe'; 
            
            videoWrapper.appendChild(mediaIframe);
            
            currentVideoInfo.textContent = `‚ñ∂Ô∏è ƒêang ph√°t YouTube: https://youtu.be/${videoId} (D√πng controls g·ªëc)`;
            updateFileActionsState(); // S·∫Ω ·∫©n n√∫t share/info/delete
        }
        
        // --- DRAG & DROP LOGIC ---

        function handleFileDrop(e) {
            e.preventDefault();
            dragOverlay.classList.add('opacity-0');
            
            const files = e.dataTransfer.files;
            const videoFile = Array.from(files).find(file => file.type.startsWith('video/'));

            if (videoFile) {
                // Drag & Drop KH√îNG C·∫§P File Handle (ch·ªâ quy·ªÅn ƒë·ªçc)
                currentFileHandle = null; 
                loadVideoFromFile(videoFile);
                currentVideoInfo.textContent = `‚ö†Ô∏è ƒê√£ t·∫£i file: ${videoFile.name} (ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc).`;
            } else {
                currentVideoInfo.textContent = "‚ùå L·ªói: Vui l√≤ng th·∫£ m·ªôt file video h·ª£p l·ªá.";
                updateFileActionsState();
            }
        }
        
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('opacity-0');
        });

        document.body.addEventListener('dragleave', () => {
             dragOverlay.classList.add('opacity-0');
        });
        
        document.body.addEventListener('drop', handleFileDrop);

        // --- FILE HANDLE ACTIONS (INFO, SHARE) ---

        /**
         * Hi·ªán Modal Th√¥ng tin File (CH·ªà D√ôNG CHO LOCAL FILE)
         */
        function showFileInfoModal() {
            if (isYouTubeEmbed || !currentFileDetails) {
                 currentVideoInfo.textContent = "üö´ L·ªói: Ch·ªâ c√≥ th·ªÉ hi·ªÉn th·ªã th√¥ng tin cho T·ªáp c·ª•c b·ªô.";
                 return;
            }

            const content = document.getElementById('fileInfoContent');
            content.innerHTML = ''; // Clear previous content
            
            // Handle Local File Info
            const date = currentFileDetails.lastModified ? new Date(currentFileDetails.lastModified) : null;
            
            let permissionStatus = 'Ch·ªâ ƒê·ªçc (Fallback/Drag)';
            let permissionColor = 'text-yellow-400';
            if (currentFileHandle) {
                permissionStatus = 'ƒê·ªçc & Ghi (FSSA)';
                permissionColor = 'text-green-400';
            }

            const data = [
                { label: 'T√™n T·ªáp', value: currentFileDetails.name || currentFileName, accent: true },
                { label: 'K√≠ch Th∆∞·ªõc', value: currentFileDetails.size ? formatBytes(currentFileDetails.size) : 'N/A' },
                { label: 'Lo·∫°i MIME', value: currentFileDetails.type || 'N/A' },
                { label: 'Quy·ªÅn Truy C·∫≠p', value: permissionStatus, color: permissionColor },
                { label: 'Ng√†y S·ª≠a ƒê·ªïi', value: date ? date.toLocaleString('vi-VN') : 'N/A' },
            ];

            content.innerHTML = data.map(item => `
                <div class="data-row">
                    <span class="font-medium text-gray-400">${item.label}:</span>
                    <span class="font-semibold ${item.color || (item.accent ? 'text-white' : 'text-gray-200')}">${item.value}</span>
                </div>
            `).join('');
            
            showModal('fileInfoModal');
        }


        /**
         * Hi·ªán th√¥ng b√°o gi·ªõi h·∫°n API thay cho ch·ª©c nƒÉng x√≥a file
         */
        function showApiLimitationMessage() {
            // Hi·ªÉn th·ªã th√¥ng b√°o ƒë·ªè
            currentVideoInfo.innerHTML = `<span class="text-red-400 font-bold">‚ö†Ô∏è GI·ªöI H·∫†N API:</span> Ch·ª©c nƒÉng x√≥a b·ªã v√¥ hi·ªáu h√≥a. Web API (FSSA) hi·ªán t·∫°i <b>kh√¥ng h·ªó tr·ª£ x√≥a t·ªáp</b> ch·ªâ v·ªõi File Handle (ch·ªâ cho ph√©p x√≥a qua Directory Handle).`;
            
            // T·ª± ƒë·ªông reset tin nh·∫Øn sau 5 gi√¢y
            setTimeout(() => {
                if(currentFileHandle) {
                    currentVideoInfo.textContent = `‚úÖ ƒê√£ c·∫•p quy·ªÅn ch·ªânh s·ª≠a cho: ${currentFileName}`;
                } else if (currentFileName) {
                    currentVideoInfo.textContent = `‚ö†Ô∏è ƒê√£ t·∫£i file: ${currentFileName} (ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc).`;
                } else {
                    currentVideoInfo.textContent = 'S·∫µn s√†ng nh·∫≠n l·ªánh...';
                }
            }, 5000);
        }
        
        /**
         * Logic Chia s·∫ª
         */
        async function handleShare() {
            if (isYouTubeEmbed || !currentFileName) {
                currentVideoInfo.textContent = "üö´ L·ªói: Kh√¥ng th·ªÉ chia s·∫ª khi ƒëang ph√°t YouTube ho·∫∑c ch∆∞a t·∫£i t·ªáp.";
                return;
            }
            
            // N·∫øu kh√¥ng c√≥ File Handle, t·ª©c l√† file ƒëang ·ªü ch·∫ø ƒë·ªô Ch·ªâ ƒê·ªçc (do Fallback ho·∫∑c Drag&Drop)
            if (!currentFileHandle) {
                showModal('permissionRequiredModal');
                currentVideoInfo.textContent = "‚ö†Ô∏è Chia s·∫ª b·ªã ch·∫∑n: C·∫ßn quy·ªÅn ƒê·ªçc & Ghi ƒë·ªÉ chia s·∫ª t·ªáp g·ªëc.";
                return;
            }

            if (!navigator.share) {
                currentVideoInfo.textContent = "üö´ L·ªói: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ chia s·∫ª native (Web Share API).";
                return;
            }
            
            // L·∫•y l·∫°i File object (d√π c√≥ handle hay kh√¥ng)
            let fileToShare = currentFileDetails;
            if (currentFileHandle) {
                try {
                    fileToShare = await currentFileHandle.getFile();
                } catch (e) {
                    console.warn("Kh√¥ng th·ªÉ l·∫•y l·∫°i file object t·ª´ handle:", e);
                    // D√πng fileDetails c≈© n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c
                }
            }


            // 1. C·ªë g·∫Øng chia s·∫ª T·ªÜP G·ªêC
            if (fileToShare) {
                try {
                    const shareData = {
                        title: `Video: ${fileToShare.name}`,
                        text: `G·ª≠i t·ªáp video ${fileToShare.name} (K√≠ch th∆∞·ªõc: ${formatBytes(fileToShare.size)}) t·ª´ PWA Video Player.`,
                        files: [fileToShare],
                    };

                    if (navigator.canShare(shareData)) {
                        await navigator.share(shareData);
                        console.log('Chia s·∫ª t·ªáp th√†nh c√¥ng!');
                        currentVideoInfo.textContent = `üîó ƒê√£ chia s·∫ª t·ªáp ${fileToShare.name} th√†nh c√¥ng!`;
                        return; 
                    }
                    console.warn("Chia s·∫ª files kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£, fallback xu·ªëng chia s·∫ª link.");
                } catch (err) {
                    // AbortError l√† b√¨nh th∆∞·ªùng, l·ªói kh√°c th√¨ log
                    if (err.name !== 'AbortError') {
                        console.error('L·ªói khi chia s·∫ª t·ªáp:', err);
                    }
                }
            }
            
            // 2. Fallback: Chia s·∫ª link ·ª©ng d·ª•ng PWA
            const shareDataFallback = {
                title: 'Video Player PWA',
                text: currentFileName ? `Xem "${currentFileName}" b·∫±ng PWA Video Player c·ªßa t√¥i. H√£y c√†i ƒë·∫∑t ·ª©ng d·ª•ng n√†y ƒë·ªÉ m·ªü file local!` : 'H√£y c√†i ƒë·∫∑t ·ª©ng d·ª•ng PWA Video Player n√†y ƒë·ªÉ m·ªü v√† ph√°t video local m·ªôt c√°ch chuy√™n nghi·ªáp!',
                url: location.href, 
            };

            try {
                await navigator.share(shareDataFallback);
                currentVideoInfo.textContent = `üîó ƒê√£ chia s·∫ª link ${currentFileName ? currentFileName : '·ª©ng d·ª•ng'} th√†nh c√¥ng!`;
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('L·ªói khi chia s·∫ª fallback:', err);
                    currentVideoInfo.textContent = '‚ùå L·ªói chia s·∫ª. Vui l√≤ng th·ª≠ l·∫°i.';
                }
            }
        }
        shareBtn.addEventListener('click', handleShare);
        
        // --- CUSTOM CONTROLS LOGIC (CH·ªà D√ôNG CHO LOCAL FILE) ---
        
        function skip(seconds) {
            if (isYouTubeEmbed) return;
            if (!videoPlayer.src) return;
            // Lu√¥n d√πng custom controls n√™n ch·ªâ c·∫ßn thay ƒë·ªïi currentTime
            videoPlayer.currentTime += seconds;
            showControls();
        }
        document.getElementById('skipBackwardBtn').addEventListener('click', () => skip(-10));
        document.getElementById('skipForwardBtn').addEventListener('click', () => skip(10));
        
        const speedRates = [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0];

        function setPlaybackSpeed(speed) {
            if (isYouTubeEmbed) return;
            videoPlayer.playbackRate = speed;
            document.getElementById('speedBtn').textContent = `${speed.toFixed(2).replace(/\.00$/, '.0')}x`;
            document.getElementById('speedMenu').classList.add('hidden');
            Array.from(document.getElementById('speedMenu').children).forEach(item => {
                if (parseFloat(item.dataset.speed) === speed) {
                    item.classList.add('bg-accent', 'text-white');
                    item.classList.remove('hover:bg-gray-700', 'text-gray-300');
                } else {
                    item.classList.remove('bg-accent', 'text-white');
                    item.classList.add('hover:bg-gray-700', 'text-gray-300');
                }
            });
            showControls();
        }

        function setupSpeedMenu() {
            const speedMenu = document.getElementById('speedMenu');
            speedRates.forEach(rate => {
                const item = document.createElement('div');
                item.className = 'p-2 text-sm text-gray-300 cursor-pointer transition duration-100 text-center';
                item.textContent = `${rate.toFixed(2).replace(/\.00$/, '.0')}x`;
                item.dataset.speed = rate;
                item.onclick = () => setPlaybackSpeed(rate);

                if (rate === 1.0) {
                    item.classList.add('bg-accent', 'text-white');
                } else {
                    item.classList.add('hover:bg-gray-700');
                }
                speedMenu.appendChild(item);
            });
            
            document.getElementById('speedBtn').addEventListener('click', (e) => {
                e.stopPropagation(); 
                if (isYouTubeEmbed) return; 
                speedMenu.classList.toggle('hidden');
                showControls();
            });

            document.addEventListener('click', (e) => {
                if (isYouTubeEmbed) return;
                if (!document.getElementById('speedBtn').contains(e.target) && !speedMenu.contains(e.target)) {
                    speedMenu.classList.add('hidden');
                }
            });
        }
        
        function toggleLoop() {
            if (isYouTubeEmbed) return;
            videoPlayer.loop = !videoPlayer.loop;
            const loopBtn = document.getElementById('loopBtn');
            const loopIcon = loopBtn.querySelector('.material-symbols-outlined');
            
            if (videoPlayer.loop) {
                loopBtn.classList.add('text-accent', 'ring-2', 'ring-accent');
                loopBtn.classList.remove('text-gray-500');
                loopIcon.style.fontVariationSettings = "'FILL' 1, 'wght' 600, 'GRAD' 0, 'opsz' 24"; 
                currentVideoInfo.textContent = `üîÅ B·∫≠t ch·∫ø ƒë·ªô L·∫∑p l·∫°i.`;
            } else {
                loopBtn.classList.remove('text-accent', 'ring-2', 'ring-accent');
                loopBtn.classList.add('text-gray-500');
                loopIcon.style.fontVariationSettings = "initial"; 
                currentVideoInfo.textContent = `üîÇ T·∫Øt ch·∫ø ƒë·ªô L·∫∑p l·∫°i.`;
            }
            showControls();
        }
        document.getElementById('loopBtn').addEventListener('click', toggleLoop);
        
        // --- CH·ª®C NƒÇNG PICTURE-IN-PICTURE (PIP) ---
        pipBtn.addEventListener('click', () => {
             if (isYouTubeEmbed) return;
             if (!videoPlayer.src) return;
             togglePiP();
        });

        function togglePiP() {
            if (isYouTubeEmbed) return;
            if (!videoPlayer.src) return;
            if (!document.pictureInPictureElement) {
                videoPlayer.requestPictureInPicture().catch(err => {
                    console.error("L·ªói PiP: ", err);
                    currentVideoInfo.textContent = "üö´ L·ªói: Tr√¨nh duy·ªát kh√¥ng cho ph√©p PiP ho·∫∑c ƒëang b·ªã ch·∫∑n.";
                });
            } else {
                document.exitPictureInPicture().catch(err => {
                    console.error("L·ªói tho√°t PiP: ", err);
                });
            }
            showControls();
        }
        
        /**
         * K√≠ch ho·∫°t Media Session API ƒë·ªÉ hi·ªÉn th·ªã Menu ƒêi·ªÅu khi·ªÉn OS/TV (Ch·ª©c nƒÉng Cast)
         */
        function enableOSMediaControls() {
            if (isYouTubeEmbed) return;
            if (!videoPlayer.src) {
                currentVideoInfo.textContent = "üö´ L·ªói: Vui l√≤ng t·∫£i video tr∆∞·ªõc khi truy·ªÅn.";
                return;
            }

            // 1. ƒê·∫£m b·∫£o video ƒëang ch·∫°y ƒë·ªÉ k√≠ch ho·∫°t Media Session
            if (videoPlayer.paused) {
                videoPlayer.play().catch(e => console.error("L·ªói Play khi Cast: ", e));
            }

            // 2. Thi·∫øt l·∫≠p/C·∫≠p nh·∫≠t Media Session (ƒë·∫£m b·∫£o OS nh·∫≠n ƒë∆∞·ª£c metadata)
            // L∆ØU √ù: setupMediaSession() ƒë∆∞·ª£c g·ªçi l·∫°i ·ªü ƒë√¢y ƒë·ªÉ ƒë·∫£m b·∫£o OS nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o m·ªõi nh·∫•t.
            setupMediaSession();
            
            // 3. C·∫≠p nh·∫≠t UI
            currentVideoInfo.innerHTML = 'üì∫ ƒê√£ **k√≠ch ho·∫°t Menu ƒêi·ªÅu khi·ªÉn OS/TV** (Media Session API). B·∫°n c√≥ th·ªÉ ƒëi·ªÅu khi·ªÉn tr√™n thanh t√°c v·ª•/th√¥ng b√°o.';
        }
        
        // --- G√ÅN L·∫†I CH·ª®C NƒÇNG CHO N√öT CAST ---
        castBtn.addEventListener('click', enableOSMediaControls);
        // --------------------------------------

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            if (!videoPlayer.src && !isYouTubeEmbed) return; 

            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                videoWrapper.requestFullscreen().catch(err => {
                    console.error(`L·ªói Fullscreen: ${err.message} (${err.name})`);
                    currentVideoInfo.textContent = `üö´ L·ªói: Tr√¨nh duy·ªát ch·∫∑n ch·∫ø ƒë·ªô to√†n m√†n m√†n h√¨nh.`;
                });
            }
        });
        
        // Volume Control
        function updateVolumeIcon(volume, isMuted) {
            const volumeIcon = document.getElementById('volumeIcon');
            let iconName = 'volume_up';
            if (isMuted || volume === 0) {
                iconName = 'volume_off';
            } else if (volume > 0.5) {
                iconName = 'volume_up';
            } else {
                iconName = 'volume_down';
            }
            volumeIcon.textContent = iconName;
        }

        document.getElementById('volumeSlider').addEventListener('input', () => {
            if (isYouTubeEmbed) return;
            const volumeSlider = document.getElementById('volumeSlider');
            const volume = volumeSlider.value / 100;
            videoPlayer.volume = volume;
            videoPlayer.muted = false;
            updateVolumeIcon(volume, videoPlayer.muted);
        });

        document.getElementById('volumeBtn').addEventListener('click', () => {
            if (isYouTubeEmbed) return;
            videoPlayer.muted = !videoPlayer.muted;
            updateVolumeIcon(videoPlayer.volume, videoPlayer.muted);
            if (!videoPlayer.muted && videoPlayer.volume === 0) {
                videoPlayer.volume = 0.5;
                document.getElementById('volumeSlider').value = 50;
                updateVolumeIcon(videoPlayer.volume, videoPlayer.muted);
            }
        });

        // Play/Pause Toggle
        function togglePlayPause() {
            if (isYouTubeEmbed) return;
            if (!videoPlayer.src) return;
            if (videoPlayer.paused || videoPlayer.ended) {
                videoPlayer.play().catch(e => console.error("L·ªói Play: ", e));
            } else {
                videoPlayer.pause();
            }
        }
        document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
        videoPlayer.addEventListener('click', (event) => {
            if (isYouTubeEmbed) return;
            // Ch·ªâ d√πng Custom Controls
            if (event.target.closest('#customControls')) { return; }
            togglePlayPause();
        });
        
        /**
         * Thi·∫øt l·∫≠p Media Session API (K√≠ch ho·∫°t ƒëi·ªÅu khi·ªÉn OS)
         * H√†m n√†y ƒë∆∞·ª£c g·ªçi khi video load v√† m·ªói khi tr·∫°ng th√°i Play/Pause thay ƒë·ªïi.
         */
        function setupMediaSession() {
            if (!('mediaSession' in navigator)) return;
            
            // Ch·ªâ thi·∫øt l·∫≠p khi c√≥ video local
            if (videoPlayer.src && !isYouTubeEmbed) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: currentFileName || 'Video C·ª•c B·ªô',
                    artist: 'Tr√¨nh Ph√°t PWA',
                    album: 'ƒêang ph√°t video c√° nh√¢n', 
                });

                // Set Action Handlers (Quan tr·ªçng ƒë·ªÉ k√≠ch ho·∫°t menu ƒëi·ªÅu khi·ªÉn OS)
                navigator.mediaSession.setActionHandler('play', () => { 
                    videoPlayer.play(); 
                    currentVideoInfo.textContent = 'üéµ ƒê√£ ti·∫øp t·ª•c ph√°t (Qua ƒëi·ªÅu khi·ªÉn OS).';
                });
                navigator.mediaSession.setActionHandler('pause', () => { 
                    videoPlayer.pause(); 
                    currentVideoInfo.textContent = '‚è∏ ƒê√£ t·∫°m d·ª´ng (Qua ƒëi·ªÅu khi·ªÉn OS).';
                });
                navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                    const seekTime = details.seekOffset || 10;
                    videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - seekTime);
                    currentVideoInfo.textContent = `‚è™ Tua l·∫°i ${seekTime}s (Qua ƒëi·ªÅu khi·ªÉn OS).`;
                });
                navigator.mediaSession.setActionHandler('seekforward', (details) => {
                    const seekTime = details.seekOffset || 10;
                    videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + seekTime);
                    currentVideoInfo.textContent = `‚è© Tua t·ªõi ${seekTime}s (Qua ƒëi·ªÅu khi·ªÉn OS).`;
                });
            } else {
                // X√≥a Handlers khi kh√¥ng c√≥ video local/ƒëang l√† YouTube
                navigator.mediaSession.metadata = null;
                navigator.mediaSession.setActionHandler('play', null);
                navigator.mediaSession.setActionHandler('pause', null);
                navigator.mediaSession.setActionHandler('seekbackward', null);
                navigator.mediaSession.setActionHandler('seekforward', null);
            }
        }

        // --- TOOLTIP LOGIC M·ªöI ---
        function showTooltip(element) {
            const title = element.title;
            if (!title) return; 

            customTooltip.textContent = title;
            customTooltip.classList.remove('hidden');
            
            const rect = element.getBoundingClientRect();
            
            const tooltipX = rect.left + (rect.width / 2);
            const tooltipY = rect.top - 10; 

            customTooltip.style.left = `${tooltipX}px`;
            customTooltip.style.top = `${tooltipY}px`;
            
            requestAnimationFrame(() => {
                const tooltipWidth = customTooltip.offsetWidth;
                customTooltip.style.transform = `translateX(-${tooltipWidth / 2}px) translateY(0)`;
                customTooltip.classList.add('tooltip-visible');
            });
        }

        function hideTooltip() {
            customTooltip.classList.remove('tooltip-visible');
            // ·∫®n sau transition ƒë·ªÉ tr√°nh nh·∫•p nh√°y
            setTimeout(() => {
                customTooltip.classList.add('hidden');
                customTooltip.style.transform = 'translateY(10px)';
            }, 200);
        }

        function setupTooltips() {
            const buttons = document.querySelectorAll('button[title], #speedBtn[title]');
            
            buttons.forEach(button => {
                if (button.id === 'speedMenu') return;

                button.addEventListener('mouseenter', () => showTooltip(button));
                button.addEventListener('mouseleave', hideTooltip);
            });

            controlsOverlay.addEventListener('mouseleave', hideTooltip);
        }
        // --- END TOOLTIP LOGIC M·ªöI ---


        // --- EVENT LISTENERS ---

        // Controls visibility
        videoWrapper.addEventListener('mousemove', () => { if (!isYouTubeEmbed) showControls(); });
        videoWrapper.addEventListener('mouseenter', () => { if (!isYouTubeEmbed) showControls(); });
        videoWrapper.addEventListener('mouseleave', () => {
            if (!videoPlayer.paused && !isYouTubeEmbed) {
                hideControls();
            }
        });
        
        // Icon updates
        videoPlayer.addEventListener('play', () => {
            if (isYouTubeEmbed) return;
            document.getElementById('playPauseIcon').textContent = 'pause'; 
            setupMediaSession(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i Play cho Media Session
            setTimeout(hideControls, 1000); 
        });
        videoPlayer.addEventListener('pause', () => {
            if (isYouTubeEmbed) return;
            document.getElementById('playPauseIcon').textContent = 'play_arrow'; 
            setupMediaSession(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i Pause cho Media Session
            showControls();
        });
        
        // Fullscreen Icon update
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                document.getElementById('fullscreenIcon').textContent = 'fullscreen_exit';
            } else {
                document.getElementById('fullscreenIcon').textContent = 'fullscreen';
            }
        });
        
        // Time and Progress Bar Update (√Åp d·ª•ng cho c·∫£ 2 ch·∫ø ƒë·ªô)
        videoPlayer.addEventListener('loadedmetadata', () => {
            if (isYouTubeEmbed) return; 

            // === ASPECT RATIO TH·ª∞C C·ª¶A VIDEO ===
            videoWrapper.classList.add('aspect-ratio-box');
            
            const ratio = videoPlayer.videoHeight / videoPlayer.videoWidth;
            const paddingBottom = ratio * 100; 
            // C·∫≠p nh·∫≠t bi·∫øn CSS ƒë·ªÉ kh·ªõp t·ªâ l·ªá khung h√¨nh
            videoWrapper.style.setProperty('--video-ratio', `${paddingBottom}%`);
            
            // 1. Reset Controls (Lu√¥n d√πng Custom Controls)
            videoPlayer.controls = false; 
            controlsOverlay.classList.remove('hidden'); 

            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');
            progressBar.max = videoPlayer.duration;
            
            timeDisplay.textContent = `${formatTime(0)} / ${formatTime(videoPlayer.duration)}`;
            currentVideoInfo.textContent = `ƒêang ph√°t: ${currentFileName || 'Video'}`;
            
            document.getElementById('volumeSlider').value = videoPlayer.volume * 100;
            updateVolumeIcon(videoPlayer.volume, videoPlayer.muted);
            
            // NEW: Setup Media Session (Quan tr·ªçng!)
            setupMediaSession();
        });

        videoPlayer.addEventListener('timeupdate', () => {
            if (isYouTubeEmbed) return; 

            // C·∫≠p nh·∫≠t progress bar 
            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');
            if (document.activeElement !== progressBar) {
                progressBar.value = videoPlayer.currentTime;
            }
            
            timeDisplay.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
        });

        document.getElementById('progressBar').addEventListener('input', () => {
            if (isYouTubeEmbed) return; 
            if (!isNaN(videoPlayer.duration) && videoPlayer.duration > 0) {
                videoPlayer.currentTime = document.getElementById('progressBar').value;
            }
            showControls(); 
        });
        
        
        // Kh·ªüi t·∫°o menu t·ªëc ƒë·ªô v√† Tooltips
        setupSpeedMenu();
        setupTooltips();
        
        // Ki·ªÉm tra h·ªó tr·ª£ PiP khi ·ª©ng d·ª•ng t·∫£i
        function initApp() {
            if (!document.pictureInPictureEnabled) {
                pipBtn.classList.add('hidden');
                pipBtn.title = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ PiP";
            } else {
                pipBtn.classList.remove('hidden');
            }
            
            // PiP/Cast UI change on state
            videoPlayer.addEventListener('enterpictureinpicture', () => {
                currentVideoInfo.textContent = 'üñºÔ∏è ƒê√£ b·∫≠t PiP. Video ƒëang ch·∫°y trong c·ª≠a s·ªï n·ªïi.';
            });

            videoPlayer.addEventListener('leavepictureinpicture', () => {
                currentVideoInfo.textContent = `‚úÖ ƒê√£ tho√°t PiP. ƒêang ph√°t: ${currentFileName}`;
            });
        }
        
        window.onload = function() {
            initApp();
            // Ti·∫øp t·ª•c PWA launchQueue n·∫øu c√≥ (logic ·ªü d∆∞·ªõi)
            if ('launchQueue' in window) {
                console.log('[File Handler] API supported. Setting consumer... (PWA)');
                window.launchQueue.setConsumer(async (launchParams) => {
                    if (launchParams.files && launchParams.files.length > 0) {
                        console.log('[File Handler] File(s) received.');
                        
                        const fileHandle = launchParams.files[0];
                        
                        try {
                            const permissionStatus = await fileHandle.queryPermission({ mode: 'readwrite' });
                            if (permissionStatus !== 'granted') {
                                 await fileHandle.requestPermission({ mode: 'readwrite' });
                            }

                            // C·∫¨P NH·∫¨T HANDLE KHI KH·ªûI ƒê·ªòNG
                            currentFileHandle = fileHandle; 
                            const file = await fileHandle.getFile();
                            
                            resetMediaPlayer(false); // KH√îNG RESET HANDLE
                            loadVideoFromFile(file);
                            currentVideoInfo.textContent = `üé¨ ƒêang m·ªü file qua desktop: ${file.name}`;
                        } catch (error) {
                            console.error('L·ªói khi truy c·∫≠p File Handle:', error);
                            try {
                                const file = await fileHandle.getFile();
                                currentFileHandle = null; 
                                resetMediaPlayer(false); // KH√îNG RESET HANDLE
                                loadVideoFromFile(file);
                                currentVideoInfo.textContent = `‚ö†Ô∏è M·ªü file th√†nh c√¥ng: ${file.name}`;
                            } catch (readError) {
                                console.error('L·ªói khi ƒë·ªçc file sau khi th·∫•t b·∫°i readwrite:', readError);
                                currentFileHandle = null;
                                currentVideoInfo.textContent = 'üö´ L·ªói khi c·ªë g·∫Øng m·ªü file.';
                            }
                        }
                        updateFileActionsState(); 
                    } else {
                        console.log('[File Handler] App launched without files.');
                        currentFileHandle = null; 
                        updateFileActionsState(); 
                        currentVideoInfo.textContent = '·ª®ng d·ª•ng ƒë√£ kh·ªüi ƒë·ªông. K√©o & Th·∫£ video ƒë·ªÉ ph√°t!';
                    }
                });
            } else {
                console.log('[File Handler] API not supported or PWA not installed.');
            }
        };

        // ƒê·∫£m b·∫£o r·∫±ng URL object b·ªã thu h·ªìi khi trang b·ªã ƒë√≥ng
        window.addEventListener('beforeunload', () => {
            if (currentFileURL) {
                URL.revokeObjectURL(currentFileURL);
            }
        });
        
        // --- SERVICE WORKER REGISTRATION (Gi·ªØ nguy√™n) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker: ƒêƒÉng k√Ω th√†nh c√¥ng v·ªõi scope:', reg.scope))
                    .catch(err => console.error('Service Worker: ƒêƒÉng k√Ω th·∫•t b·∫°i:', err));
            });
        }
    </script>
</body>
</html>
