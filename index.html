<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- T·∫£i Material Symbols (Outline, Fill, Weight) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <!-- === PWA MANIFEST & FILE HANDLING === -->
    <meta name="theme-color" content="#1c1b1f"> 
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* Thi·∫øt l·∫≠p font Inter cho to√†n b·ªô ·ª©ng d·ª•ng */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* T·ªëi ∆∞u thanh cu·ªôn */
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #2d3748;
        }
        /* Styling cho thanh Range Slider (Ti·∫øn tr√¨nh) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #3b82f6; /* accent */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #3b82f6; /* accent */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
            border: none;
        }

        /* Animation cho Drag & Drop Overlay */
        #drag-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        /* --- FIX ASPECT RATIO CSS (D√πng Padding-Bottom Hack) --- */
        .aspect-ratio-box {
            position: relative;
            width: 100%;
            /* Chi·ªÅu cao ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a b·ªüi padding-bottom (t·ªâ l·ªá), g√°n t·ª´ JS */
            padding-bottom: var(--video-ratio, 56.25%); /* Fallback 16:9 (9/16 * 100) */
            height: 0; /* ƒê·∫£m b·∫£o padding-bottom x√°c ƒë·ªãnh chi·ªÅu cao */
            /* QUAN TR·ªåNG: Gi·ªõi h·∫°n chi·ªÅu cao tuy·ªát ƒë·ªëi c·ªßa box ƒë·ªÉ kh√¥ng v∆∞·ª£t qu√° t·∫ßm nh√¨n, gi√∫p controls kh√¥ng b·ªã cu·ªôn */
            max-height: calc(100vh - 180px); /* Kho·∫£ng 180px cho header, padding v√† margin */
            overflow: hidden; 
        }
        /* Video v√† Controls Overlay n·∫±m tuy·ªát ƒë·ªëi b√™n trong container gi·ªØ t·ªâ l·ªá */
        .aspect-ratio-box video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; 
        }
        /* Controls Overlay c·∫ßn n·∫±m tuy·ªát ƒë·ªëi v√† ch·ªâ √°p d·ª•ng khi custom controls ƒë∆∞·ª£c d√πng */
        .aspect-ratio-box #controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ƒê·∫£m b·∫£o n√≥ kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi object-fit: contain c·ªßa video */
            display: flex; /* B·∫Øt bu·ªôc ƒë·ªÉ cƒÉn ch·ªânh controls xu·ªëng d∆∞·ªõi */
            flex-direction: column;
            justify-content: flex-end;
            pointer-events: none;
        }


        /* --- MATERIAL SYMBOLS STYLING --- */
        /* ƒê√¢y l√† CSS chung √°p d·ª•ng hi·ªáu ·ª©ng FILL khi c√≥ class 'group' */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            transition: font-variation-settings 0.3s ease; 
            line-height: 1; 
            display: inline-block;
        }
        
        .group:hover .material-symbols-outlined,
        .group:focus-visible .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 600, 'GRAD' 0, 'opsz' 24;
        }

        /* --- CUSTOM TOOLTIP STYLING --- */
        #customTooltip {
            position: fixed; /* D√πng fixed ƒë·ªÉ n√≥ n·ªïi tr√™n m·ªçi th·ª© */
            z-index: 60; /* Cao h∆°n c·∫£ controls-overlay (z-index 50) */
            padding: 4px 8px;
            background-color: rgba(43, 43, 43, 0.9); /* N·ªÅn t·ªëi m·ªù */
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none; /* R·∫•t quan tr·ªçng: kh√¥ng ch·∫∑n s·ª± ki·ªán chu·ªôt */
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px); /* B·∫Øt ƒë·∫ßu h∆°i th·∫•p */
            white-space: nowrap;
        }
        .tooltip-visible {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
    </style>
    <script>
        // C·∫•u h√¨nh Tailwind CSS: B·∫≠t dark mode v√† m√†u s·∫Øc c∆° b·∫£n
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'background-dark': '#1f2937', // Grey 800
                        'card-dark': '#374151',      // Grey 700
                        'accent': '#3b82f6',         // Blue 500
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-4 bg-gray-800 shadow-lg flex justify-between items-center z-10">
        <!-- Title and Video Info -->
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-white">Video Player üé•</h1>
            <!-- V·ªã tr√≠ m·ªõi cho th√¥ng tin video -->
            <div id="currentVideoInfo" class="text-xs text-gray-400 mt-1">S·∫µn s√†ng nh·∫≠n l·ªánh...</div>
        </div>

        <!-- Right Buttons: Share and Select File -->
        <div class="flex items-center space-x-3">
            
            <!-- Share Button (M·∫∑c ƒë·ªãnh ·∫©n. Ch·ªâ hi·ªán khi c√≥ File Handle) -->
            <button id="shareBtn" title="Chia s·∫ª t·ªáp g·ªëc" class="group bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 transform hover:scale-105 flex items-center space-x-2 hidden">
                <span class="material-symbols-outlined text-xl">share</span>
                <span class="hidden sm:inline">Chia s·∫ª</span>
            </button>
            
            <!-- N√∫t Ch·ªçn Video (ƒê√£ th√™m class group ƒë·ªÉ fix hover icon) -->
            <button id="selectFileBtn" title="Ch·ªçn video b·∫±ng File System Access API" onclick="handleFilePicker()" class="group cursor-pointer bg-accent hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 flex items-center space-x-2">
                <span class="material-symbols-outlined text-xl">upload_file</span>
                <span>Ch·ªçn Video</span>
            </button>
            
            <!-- Hidden input for old-school fallback and PWA file launching -->
            <input type="file" id="fileInputFallback" accept="video/*" class="hidden" onchange="handleFileSelectFallback(event)">
        </div>
    </header>

    <!-- Main Content Area - Video Player takes full width -->
    <main class="flex-grow flex flex-col overflow-hidden">
        
        <!-- Video Player Area (Container) -->
        <div id="video-container" class="w-full p-4 flex flex-col items-center justify-center bg-background-dark relative flex-grow">

            <!-- Video Wrapper (Khung ch·ª©a video, d√πng ƒë·ªÉ gi·ªØ t·ªâ l·ªá v√† √°p d·ª•ng gi·ªõi h·∫°n chi·ªÅu r·ªông) -->
            <div id="video-wrapper" class="w-full rounded-xl shadow-2xl bg-black border border-gray-700 relative overflow-hidden hidden max-h-full">
                <!-- videoPlayer KH√îNG C√ì controls m·∫∑c ƒë·ªãnh, ƒë∆∞·ª£c b·∫≠t/t·∫Øt b·∫±ng JS -->
                <video id="videoPlayer"></video>
                
                <!-- Custom Controls Overlay -->
                <!-- Ch·ªâ hi·ªÉn th·ªã khi video l√† ngang/vu√¥ng. Lu√¥n n·∫±m TUY·ªÜT ƒê·ªêI b√™n trong wrapper -->
                <div id="controls-overlay" class="transition-opacity duration-300 opacity-0 pointer-events-none p-4">
                    <div id="customControls" class="w-full bg-gray-900/90 backdrop-blur-sm p-3 rounded-xl shadow-2xl border border-gray-700 flex flex-col pointer-events-auto">
                        
                        <!-- Seek Bar / Progress Bar -->
                        <input type="range" id="progressBar" value="0" min="0" max="100" class="w-full h-1 appearance-none cursor-pointer bg-accent/50 rounded-full">

                        <!-- Control Buttons Row -->
                        <div class="flex items-center justify-between mt-2">
                            
                            <!-- Left Controls: Play/Skip/Time -->
                            <div class="flex items-center space-x-3">
                                
                                <!-- Skip Backward 10s -->
                                <button id="skipBackwardBtn" title="Tua l√πi 10s" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 transform hover:scale-110 group">
                                    <span class="material-symbols-outlined text-2xl">replay_10</span>
                                </button>
                                
                                <!-- Play/Pause Button -->
                                <button id="playPauseBtn" title="Play/Pause" class="p-2 text-white bg-accent hover:bg-blue-600 rounded-full transition duration-150 transform hover:scale-110 group">
                                    <span id="playPauseIcon" class="material-symbols-outlined text-3xl">play_arrow</span>
                                </button>
                                
                                <!-- Skip Forward 10s -->
                                <button id="skipForwardBtn" title="Tua ti·∫øn 10s" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 transform hover:scale-110 group">
                                    <span class="material-symbols-outlined text-2xl">forward_10</span>
                                </button>

                                <!-- Time Display -->
                                <div id="timeDisplay" class="text-sm font-mono text-gray-300 hidden md:block">00:00 / 00:00</div>
                            </div>

                            <!-- Right Controls: Speed, Loop, PiP, Volume, Fullscreen -->
                            <div class="flex items-center space-x-3">
                                
                                <!-- Speed Control -->
                                <div class="relative group">
                                    <button id="speedBtn" title="T·ªëc ƒë·ªô ph√°t" class="p-2 text-gray-300 hover:text-white rounded-lg text-sm font-semibold transition duration-150 bg-gray-800/50">
                                        1.0x
                                    </button>
                                    <!-- Speed Menu -->
                                    <div id="speedMenu" class="absolute bottom-full mb-2 right-0 bg-gray-900 border border-gray-700 rounded-lg shadow-xl overflow-hidden hidden w-20">
                                    </div>
                                </div>
                                
                                <!-- Loop Button -->
                                <button id="loopBtn" title="L·∫∑p l·∫°i" class="p-2 text-gray-500 hover:text-accent rounded-full transition duration-150 group">
                                    <span class="material-symbols-outlined text-xl">repeat</span>
                                </button>

                                <!-- Picture-in-Picture Button (Ch·ªâ hi·ªán n·∫øu tr√¨nh duy·ªát h·ªó tr·ª£) -->
                                <button id="pipBtn" title="H√¨nh trong h√¨nh (PiP)" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 hidden group">
                                    <span class="material-symbols-outlined text-xl">picture_in_picture_alt</span>
                                </button>
                                
                                <!-- Volume Control (Hi·ªán Slider khi hover) -->
                                <div class="flex items-center space-x-2 group relative">
                                    <!-- Volume Slider (kh√¥ng c·∫ßn tooltip) -->
                                    <input type="range" id="volumeSlider" value="100" min="0" max="100" title="√Çm l∆∞·ª£ng" class="w-20 h-1 appearance-none cursor-pointer bg-gray-700 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 hidden md:block">
                                    <!-- Volume Button -->
                                    <button id="volumeBtn" title="T·∫Øt/M·ªü ti·∫øng" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 group">
                                        <span id="volumeIcon" class="material-symbols-outlined text-xl">volume_up</span>
                                    </button>
                                </div>

                                <!-- Fullscreen Button -->
                                <button id="fullscreenBtn" title="To√†n m√†n h√¨nh" class="p-2 text-gray-300 hover:text-white rounded-full transition duration-150 group">
                                    <span id="fullscreenIcon" class="material-symbols-outlined text-xl">fullscreen</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Custom Controls Overlay -->
            </div>
            <!-- End Video Wrapper -->
            
            <div id="placeholder" class="text-center text-gray-400 p-8 rounded-xl border-2 border-dashed border-gray-700 bg-gray-800 transition duration-300 flex flex-col items-center justify-center w-full max-w-lg h-64">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <p class="text-lg font-medium">K√©o & Th·∫£ Video Ho·∫∑c</p>
                <p class="text-sm mt-1">Nh·∫•n "Ch·ªçn Video" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                <p class="text-xs mt-3 text-yellow-400">üö® ƒê·ªÉ M·ªü File Tr·ª±c Ti·∫øp: C√†i ƒë·∫∑t ·ª©ng d·ª•ng PWA n√†y qua tr√¨nh duy·ªát!</p>
            </div>
        </div>
        
        <!-- CUSTOM TOOLTIP DIV (D√πng position: fixed) -->
        <div id="customTooltip" class="hidden"></div>

    </main>
    
    <!-- Drag & Drop Visual Overlay -->
    <div id="drag-overlay" class="fixed inset-0 bg-accent/30 backdrop-blur-sm z-50 pointer-events-none opacity-0 flex items-center justify-center border-4 border-dashed border-accent rounded-xl m-4">
        <p class="text-3xl font-bold text-white shadow-lg p-4 bg-accent/70 rounded-lg">TH·∫¢ VIDEO V√ÄO ƒê√ÇY</p>
    </div>

    <script>
        // Global variables
        const videoPlayer = document.getElementById('videoPlayer');
        const placeholder = document.getElementById('placeholder');
        const currentVideoInfo = document.getElementById('currentVideoInfo');
        const videoWrapper = document.getElementById('video-wrapper');
        const controlsOverlay = document.getElementById('controls-overlay');
        const dragOverlay = document.getElementById('drag-overlay');
        const shareBtn = document.getElementById('shareBtn'); 
        const fileInputFallback = document.getElementById('fileInputFallback'); 
        const customTooltip = document.getElementById('customTooltip'); // Th√™m tooltip

        // Global State for File System Access API
        let currentFileURL = null; 
        let currentFileName = null;
        let currentFileHandle = null; // L∆∞u tr·ªØ File Handle ƒë·ªÉ chia s·∫ª file g·ªëc
        let controlsTimeout;
        const defaultPlaybackRate = 1.0;
        
        // --- UTILITY FUNCTIONS ---

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainderSeconds = Math.floor(seconds % 60);
            const paddedMinutes = String(minutes).padStart(2, '0');
            const paddedSeconds = String(remainderSeconds).padStart(2, '0');
            return `${paddedMinutes}:${paddedSeconds}`;
        }

        function showControls() {
            // Ch·ªâ hi·ªÉn th·ªã controls n·∫øu ch√∫ng kh√¥ng b·ªã ·∫©n (v√¨ ƒëang d√πng native controls)
            if (controlsOverlay.classList.contains('hidden')) return;
            
            if (videoWrapper.classList.contains('hidden')) return;
            controlsOverlay.classList.remove('opacity-0');
            clearTimeout(controlsTimeout);
            
            if (!videoPlayer.paused) {
                controlsTimeout = setTimeout(() => {
                    controlsOverlay.classList.add('opacity-0');
                }, 3000);
            }
        }

        function hideControls() {
            if (controlsOverlay.classList.contains('hidden')) return;
            clearTimeout(controlsTimeout);
            controlsOverlay.classList.add('opacity-0');
        }

        /**
         * C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Chia s·∫ª d·ª±a tr√™n File Handle.
         */
        function updateShareButtonState() {
            // N√∫t Share ch·ªâ hi·ªán khi c√≥ File Handle (ƒë√£ xin quy·ªÅn ch·ªânh s·ª≠a)
            if (currentFileHandle) {
                shareBtn.classList.remove('hidden');
                shareBtn.title = "Chia s·∫ª t·ªáp g·ªëc (Y√™u c·∫ßu quy·ªÅn ch·ªânh s·ª≠a)";
            } else {
                shareBtn.classList.add('hidden');
            }
        }

        // --- CORE APPLICATION LOGIC ---

        /**
         * T·∫£i v√† b·∫Øt ƒë·∫ßu ph√°t video t·ª´ File object.
         * @param {File} file - ƒê·ªëi t∆∞·ª£ng File
         */
        function loadVideoFromFile(file) {
            if (currentFileURL) {
                URL.revokeObjectURL(currentFileURL);
            }

            const objectURL = URL.createObjectURL(file);
            currentFileURL = objectURL;
            currentFileName = file.name;
            videoPlayer.src = currentFileURL;
            videoPlayer.load();

            // Reset t·ªëc ƒë·ªô ph√°t v√† c·∫≠p nh·∫≠t giao di·ªán
            videoPlayer.playbackRate = defaultPlaybackRate;
            document.getElementById('speedBtn').textContent = `${defaultPlaybackRate.toFixed(1)}x`;

            // C·∫≠p nh·∫≠t giao di·ªán: ·∫®n placeholder, hi·ªán video wrapper
            placeholder.classList.add('hidden');
            videoWrapper.classList.remove('hidden');
            videoWrapper.classList.add('aspect-ratio-box');
            
            videoPlayer.play().catch(e => {
                console.warn("L·ªói t·ª± ƒë·ªông ph√°t: " + e.message);
                // CH·ªà C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI V√Ä T√äN FILE (ƒê√É X√ìA TH·ªúI GIAN)
                currentVideoInfo.textContent = `‚ñ∂Ô∏è ƒê√£ t·∫£i: ${file.name}. Vui l√≤ng nh·∫•n n√∫t Play.`;
                showControls();
            });
            
            // QUAN TR·ªåNG: C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Share sau khi video load
            updateShareButtonState();
        }
        
        // --- FILE PICKER & FALLBACK LOGIC ---

        /**
         * X·ª≠ l√Ω file b·∫±ng File System Access API (y√™u c·∫ßu quy·ªÅn ch·ªânh s·ª≠a).
         */
        async function handleFilePicker() {
            // Fallback Level 1: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ FSSA
            if (!window.showOpenFilePicker) {
                currentVideoInfo.textContent = 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ FSSA. M·ªü h·ªôp tho·∫°i file truy·ªÅn th·ªëng...';
                fileInputFallback.click(); 
                return;
            }

            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'Video Files',
                        accept: { 'video/*': ['.mp4', '.mov', '.webm', '.mkv', '.ogg', '.avi'] }
                    }],
                    multiple: false,
                    mode: 'readwrite' 
                });

                currentFileHandle = fileHandle; 
                const file = await fileHandle.getFile();
                loadVideoFromFile(file);
                // CH·ªà C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI V√Ä T√äN FILE (ƒê√É X√ìA TH·ªúI GIAN)
                currentVideoInfo.textContent = `‚úÖ ƒê√£ c·∫•p quy·ªÅn ch·ªânh s·ª≠a cho: ${file.name}`;

            } catch (err) {
                if (err.name === 'AbortError') {
                    // Ng∆∞·ªùi d√πng ch·ªß ƒë·ªông h·ªßy (h·ªç kh√¥ng mu·ªën ch·ªçn file n·ªØa)
                    currentVideoInfo.textContent = 'Ch·ªçn t·ªáp b·ªã h·ªßy.';
                } else {
                    // L·ªói b·∫•t ng·ªù (kh√¥ng ph·∫£i do h·ªßy ho·∫∑c l·ªói quy·ªÅn) -> Fallback Level 2
                    console.error('L·ªói File System Access API:', err);
                    currentFileHandle = null; 
                    currentVideoInfo.textContent = '‚ùå L·ªói FSSA. ƒêang chuy·ªÉn sang ch·ªçn file truy·ªÅn th·ªëng...';
                    fileInputFallback.click(); // K√≠ch ho·∫°t ch·ªçn file truy·ªÅn th·ªëng
                }
                updateShareButtonState(); // ƒê·∫£m b·∫£o n√∫t share ·∫©n n·∫øu c√≥ l·ªói
            }
        }

        /**
         * Fallback cho input[type=file] (ch·ªâ quy·ªÅn ƒë·ªçc)
         */
        function handleFileSelectFallback(event) {
            const files = event.target.files;
            if (files.length > 0) {
                currentFileHandle = null; // Lu√¥n reset khi d√πng Fallback
                loadVideoFromFile(files[0]);
            }
        }
        
        // --- DRAG & DROP LOGIC ---

        function handleFileDrop(e) {
            e.preventDefault();
            dragOverlay.classList.add('opacity-0');
            
            const files = e.dataTransfer.files;
            const videoFile = Array.from(files).find(file => file.type.startsWith('video/'));

            if (videoFile) {
                // Drag & Drop KH√îNG C·∫§P File Handle (ch·ªâ quy·ªÅn ƒë·ªçc)
                currentFileHandle = null; 
                loadVideoFromFile(videoFile);
            } else {
                currentVideoInfo.textContent = "‚ùå L·ªói: Vui l√≤ng th·∫£ m·ªôt file video h·ª£p l·ªá.";
                updateShareButtonState();
            }
        }
        
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('opacity-0');
        });

        document.body.addEventListener('dragleave', () => {
             dragOverlay.classList.add('opacity-0');
        });
        
        document.body.addEventListener('drop', handleFileDrop);

        // --- SHARE LOGIC (Gi·ªØ nguy√™n) ---
        async function handleShare() {
            if (!navigator.share) {
                currentVideoInfo.textContent = "üö´ L·ªói: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ chia s·∫ª native (Web Share API).";
                return;
            }

            // 1. C·ªë g·∫Øng chia s·∫ª T·ªÜP G·ªêC n·∫øu c√≥ File Handle (c√≥ quy·ªÅn ch·ªânh s·ª≠a)
            if (currentFileHandle) {
                try {
                    const fileToShare = await currentFileHandle.getFile();
                    const shareData = {
                        title: `Video: ${fileToShare.name}`,
                        text: `G·ª≠i t·ªáp video ${fileToShare.name} (K√≠ch th∆∞·ªõc: ${Math.round(fileToShare.size / 1024 / 1024)}MB) t·ª´ PWA Video Player.`,
                        files: [fileToShare],
                    };

                    if (navigator.canShare(shareData)) {
                        await navigator.share(shareData);
                        console.log('Chia s·∫ª t·ªáp th√†nh c√¥ng!');
                        currentVideoInfo.textContent = `üîó ƒê√£ chia s·∫ª t·ªáp ${fileToShare.name} th√†nh c√¥ng!`;
                        return; 
                    }
                    console.warn("Chia s·∫ª files kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£, fallback xu·ªëng chia s·∫ª link.");
                } catch (err) {
                    console.error('L·ªói khi chia s·∫ª t·ªáp:', err);
                }
            }
            
            // 2. Fallback: Chia s·∫ª link ·ª©ng d·ª•ng PWA
            const shareDataFallback = {
                title: 'Video Player PWA',
                text: currentFileName ? `Xem "${currentFileName}" b·∫±ng PWA Video Player c·ªßa t√¥i. H√£y c√†i ƒë·∫∑t ·ª©ng d·ª•ng n√†y ƒë·ªÉ m·ªü file local!` : 'H√£y c√†i ƒë·∫∑t ·ª©ng d·ª•ng PWA Video Player n√†y ƒë·ªÉ m·ªü v√† ph√°t video local m·ªôt c√°ch chuy√™n nghi·ªáp!',
                url: location.href, 
            };

            try {
                await navigator.share(shareDataFallback);
                currentVideoInfo.textContent = `üîó ƒê√£ chia s·∫ª link ${currentFileName ? currentFileName : '·ª©ng d·ª•ng'} th√†nh c√¥ng!`;
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('L·ªói khi chia s·∫ª fallback:', err);
                    currentVideoInfo.textContent = '‚ùå L·ªói chia s·∫ª. Vui l√≤ng th·ª≠ l·∫°i.';
                }
            }
        }
        shareBtn.addEventListener('click', handleShare);
        
        // --- CUSTOM CONTROLS LOGIC (Ch·ªâ ch·∫°y khi d√πng Custom Controls) ---
        
        function skip(seconds) {
            if (!videoPlayer.src) return;
            // Ch·ªâ show controls custom n·∫øu ch√∫ng ƒëang ho·∫°t ƒë·ªông
            if (!videoPlayer.controls) {
                videoPlayer.currentTime += seconds;
                showControls();
            } else {
                videoPlayer.currentTime += seconds;
            }
        }
        document.getElementById('skipBackwardBtn').addEventListener('click', () => skip(-10));
        document.getElementById('skipForwardBtn').addEventListener('click', () => skip(10));
        
        const speedRates = [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0];

        function setPlaybackSpeed(speed) {
            if (videoPlayer.controls) return; // N·∫øu d√πng native controls th√¨ b·ªè qua
            videoPlayer.playbackRate = speed;
            document.getElementById('speedBtn').textContent = `${speed.toFixed(2).replace(/\.00$/, '.0')}x`;
            document.getElementById('speedMenu').classList.add('hidden');
            Array.from(document.getElementById('speedMenu').children).forEach(item => {
                if (parseFloat(item.dataset.speed) === speed) {
                    item.classList.add('bg-accent', 'text-white');
                    item.classList.remove('hover:bg-gray-700', 'text-gray-300');
                } else {
                    item.classList.remove('bg-accent', 'text-white');
                    item.classList.add('hover:bg-gray-700', 'text-gray-300');
                }
            });
            showControls();
        }

        function setupSpeedMenu() {
            const speedMenu = document.getElementById('speedMenu');
            speedRates.forEach(rate => {
                const item = document.createElement('div');
                item.className = 'p-2 text-sm text-gray-300 cursor-pointer transition duration-100 text-center';
                item.textContent = `${rate.toFixed(2).replace(/\.00$/, '.0')}x`;
                item.dataset.speed = rate;
                item.onclick = () => setPlaybackSpeed(rate);

                if (rate === 1.0) {
                    item.classList.add('bg-accent', 'text-white');
                } else {
                    item.classList.add('hover:bg-gray-700');
                }
                speedMenu.appendChild(item);
            });
            
            document.getElementById('speedBtn').addEventListener('click', (e) => {
                e.stopPropagation(); 
                if (videoPlayer.controls) return; // Kh√¥ng hi·ªÉn th·ªã n·∫øu d√πng native controls
                speedMenu.classList.toggle('hidden');
                showControls();
            });

            document.addEventListener('click', (e) => {
                if (!document.getElementById('speedBtn').contains(e.target) && !speedMenu.contains(e.target)) {
                    speedMenu.classList.add('hidden');
                }
            });
        }
        
        function toggleLoop() {
            if (videoPlayer.controls) return; // N·∫øu d√πng native controls th√¨ b·ªè qua
            videoPlayer.loop = !videoPlayer.loop;
            const loopBtn = document.getElementById('loopBtn');
            const loopIcon = loopBtn.querySelector('.material-symbols-outlined');
            
            if (videoPlayer.loop) {
                loopBtn.classList.add('text-accent', 'ring-2', 'ring-accent');
                loopBtn.classList.remove('text-gray-500');
                loopIcon.style.fontVariationSettings = "'FILL' 1, 'wght' 600, 'GRAD' 0, 'opsz' 24"; 
                currentVideoInfo.textContent = `üîÅ B·∫≠t ch·∫ø ƒë·ªô L·∫∑p l·∫°i.`;
            } else {
                loopBtn.classList.remove('text-accent', 'ring-2', 'ring-accent');
                loopBtn.classList.add('text-gray-500');
                loopIcon.style.fontVariationSettings = "initial"; 
                currentVideoInfo.textContent = `üîÇ T·∫Øt ch·∫ø ƒë·ªô L·∫∑p l·∫°i.`;
            }
            showControls();
        }
        document.getElementById('loopBtn').addEventListener('click', toggleLoop);
        
        document.getElementById('pipBtn').addEventListener('click', () => {
             if (!videoPlayer.src) return;
             togglePiP();
        });
        
        function togglePiP() {
            if (!videoPlayer.src) return;
            if (!document.pictureInPictureElement) {
                videoPlayer.requestPictureInPicture().catch(err => {
                    console.error("L·ªói PiP: ", err);
                    currentVideoInfo.textContent = "üö´ L·ªói: Tr√¨nh duy·ªát kh√¥ng cho ph√©p PiP ho·∫∑c ƒëang b·ªã ch·∫∑n.";
                });
            } else {
                document.exitPictureInPicture().catch(err => {
                    console.error("L·ªói tho√°t PiP: ", err);
                });
            }
            showControls();
        }
        
        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            if (!videoPlayer.src) return;
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                videoWrapper.requestFullscreen().catch(err => {
                    console.error(`L·ªói Fullscreen: ${err.message} (${err.name})`);
                    currentVideoInfo.textContent = `üö´ L·ªói: Tr√¨nh duy·ªát ch·∫∑n ch·∫ø ƒë·ªô to√†n m√†n h√¨nh.`;
                });
            }
        });
        
        // Volume Control
        function updateVolumeIcon(volume, isMuted) {
            const volumeIcon = document.getElementById('volumeIcon');
            let iconName = 'volume_up';
            if (isMuted || volume === 0) {
                iconName = 'volume_off';
            } else if (volume > 0.5) {
                iconName = 'volume_up';
            } else {
                iconName = 'volume_down';
            }
            volumeIcon.textContent = iconName;
        }

        document.getElementById('volumeSlider').addEventListener('input', () => {
            const volumeSlider = document.getElementById('volumeSlider');
            const volume = volumeSlider.value / 100;
            videoPlayer.volume = volume;
            videoPlayer.muted = false;
            updateVolumeIcon(volume, videoPlayer.muted);
        });

        document.getElementById('volumeBtn').addEventListener('click', () => {
            videoPlayer.muted = !videoPlayer.muted;
            updateVolumeIcon(videoPlayer.volume, videoPlayer.muted);
            if (!videoPlayer.muted && videoPlayer.volume === 0) {
                videoPlayer.volume = 0.5;
                document.getElementById('volumeSlider').value = 50;
                updateVolumeIcon(videoPlayer.volume, videoPlayer.muted);
            }
        });

        // Play/Pause Toggle
        function togglePlayPause() {
            if (!videoPlayer.src) return;
            if (videoPlayer.paused || videoPlayer.ended) {
                videoPlayer.play().catch(e => console.error("L·ªói Play: ", e));
            } else {
                videoPlayer.pause();
            }
        }
        document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
        videoPlayer.addEventListener('click', (event) => {
            // Kh√¥ng can thi·ªáp n·∫øu ƒëang d√πng native controls
            if (videoPlayer.controls) return;
            // NgƒÉn ch·∫∑n click v√†o custom controls k√≠ch ho·∫°t pause
            if (event.target.closest('#customControls')) { return; }
            togglePlayPause();
        });

        // --- TOOLTIP LOGIC M·ªöI ---
        function showTooltip(element) {
            // N·∫øu ƒëang d√πng native controls th√¨ kh√¥ng hi·ªÉn th·ªã tooltip custom
            if (videoPlayer.controls) return; 

            const title = element.title;
            if (!title) return; // Kh√¥ng c√≥ title th√¨ th√¥i

            customTooltip.textContent = title;
            customTooltip.classList.remove('hidden');
            
            // L·∫•y v·ªã tr√≠ c·ªßa n√∫t
            const rect = element.getBoundingClientRect();
            
            // T√≠nh to√°n v·ªã tr√≠ c·ªßa tooltip (cƒÉn gi·ªØa theo chi·ªÅu ngang c·ªßa n√∫t, n·∫±m tr√™n n√∫t)
            const tooltipX = rect.left + (rect.width / 2);
            const tooltipY = rect.top - 10; // C√°ch n√∫t 10px

            // Set v·ªã tr√≠ (d√πng style.left/top)
            customTooltip.style.left = `${tooltipX}px`;
            customTooltip.style.top = `${tooltipY}px`;
            
            // CƒÉn ch·ªânh t√¢m c·ªßa tooltip
            // D√πng requestAnimationFrame ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√£ render xong text v√† c√≥ width ch√≠nh x√°c
            requestAnimationFrame(() => {
                const tooltipWidth = customTooltip.offsetWidth;
                customTooltip.style.transform = `translateX(-${tooltipWidth / 2}px) translateY(0)`;
                customTooltip.classList.add('tooltip-visible');
            });
        }

        function hideTooltip() {
            customTooltip.classList.remove('tooltip-visible');
            // ·∫®n sau transition ƒë·ªÉ tr√°nh nh·∫•p nh√°y
            setTimeout(() => {
                customTooltip.classList.add('hidden');
                customTooltip.style.transform = 'translateY(10px)';
            }, 200);
        }

        function setupTooltips() {
            // L·∫•y t·∫•t c·∫£ c√°c n√∫t b√™n trong customControls c√≥ thu·ªôc t√≠nh title
            const buttons = document.querySelectorAll('#customControls button[title], #speedBtn[title]');
            
            buttons.forEach(button => {
                // ƒê·∫£m b·∫£o kh√¥ng g·∫Øn s·ª± ki·ªán cho n√∫t speedMenu v√¨ n√≥ kh√¥ng ph·∫£i n√∫t ƒëi·ªÅu khi·ªÉn ch√≠nh
                if (button.id === 'speedMenu') return;

                button.addEventListener('mouseenter', () => showTooltip(button));
                button.addEventListener('mouseleave', hideTooltip);
            });

            // N·∫øu r√™ chu·ªôt ra kh·ªèi khu v·ª±c controls th√¨ ·∫©n tooltip
            controlsOverlay.addEventListener('mouseleave', hideTooltip);
        }
        // --- END TOOLTIP LOGIC M·ªöI ---


        // --- EVENT LISTENERS ---

        // Controls visibility (Ch·ªâ ch·∫°y khi custom controls ƒëang ho·∫°t ƒë·ªông)
        videoWrapper.addEventListener('mousemove', () => { if (!videoPlayer.controls) showControls(); });
        videoWrapper.addEventListener('mouseenter', () => { if (!videoPlayer.controls) showControls(); });
        videoWrapper.addEventListener('mouseleave', () => {
            if (!videoPlayer.controls && !videoPlayer.paused) {
                hideControls();
            }
        });
        
        // Icon updates
        videoPlayer.addEventListener('play', () => {
            if (!videoPlayer.controls) {
                document.getElementById('playPauseIcon').textContent = 'pause'; 
                setTimeout(hideControls, 1000); 
            }
        });
        videoPlayer.addEventListener('pause', () => {
            if (!videoPlayer.controls) {
                document.getElementById('playPauseIcon').textContent = 'play_arrow'; 
                showControls();
            }
        });
        
        // Fullscreen Icon update
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                document.getElementById('fullscreenIcon').textContent = 'fullscreen_exit';
            } else {
                document.getElementById('fullscreenIcon').textContent = 'fullscreen';
            }
        });
        
        // Time and Progress Bar Update (√Åp d·ª•ng cho c·∫£ 2 ch·∫ø ƒë·ªô)
        videoPlayer.addEventListener('loadedmetadata', () => {
            const ratio = videoPlayer.videoHeight / videoPlayer.videoWidth;
            const paddingBottom = ratio * 100; 
            videoWrapper.style.setProperty('--video-ratio', `${paddingBottom}%`);

            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');
            progressBar.max = videoPlayer.duration;
            
            let statusText = ''; // Bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i format

            // 1. Reset t·∫•t c·∫£ max-w classes v√† Controls
            videoWrapper.classList.remove('max-w-5xl', 'max-w-xs', 'md:max-w-sm'); 
            videoPlayer.controls = false; // T·∫Øt m·∫∑c ƒë·ªãnh
            controlsOverlay.classList.remove('hidden'); // M·ªü custom controls m·∫∑c ƒë·ªãnh

            if (videoPlayer.videoHeight > videoPlayer.videoWidth) {
                // Video D·ªçc (Portrait) -> D√πng Native Controls
                videoWrapper.classList.add('max-w-xs', 'md:max-w-sm'); 
                statusText = ' (D·ªçc)'; // D√πng ƒë·ªÉ hi·ªÉn th·ªã trong header n·∫øu c·∫ßn
                
                // === B·∫¨T NATIVE CONTROLS V√Ä ·∫®N CUSTOM CONTROLS ===
                videoPlayer.controls = true;
                controlsOverlay.classList.add('hidden'); 
            } else {
                // Video Ngang ho·∫∑c Vu√¥ng (Landscape/Square) -> D√πng Custom Controls
                videoWrapper.classList.add('max-w-5xl');
                statusText = ' (Ngang/Vu√¥ng)'; // D√πng ƒë·ªÉ hi·ªÉn th·ªã trong header n·∫øu c·∫ßn
                
                // === T·∫ÆT NATIVE CONTROLS V√Ä HI·ªÇN TH·ªä CUSTOM CONTROLS ===
                videoPlayer.controls = false;
                controlsOverlay.classList.remove('hidden');
            }
            
            // C·∫≠p nh·∫≠t #timeDisplay (B·ªé CH·ªÆ CUSTOM CONTROLS)
            timeDisplay.textContent = `${formatTime(0)} / ${formatTime(videoPlayer.duration)}`;
            
            // C·∫≠p nh·∫≠t #currentVideoInfo (B·ªé TH·ªúI GIAN V√Ä CH·ªÆ FORMAT)
            currentVideoInfo.textContent = `ƒêang ph√°t: ${currentFileName || 'Video'}`;
            // --------------------------------------------------------
            
            document.getElementById('volumeSlider').value = videoPlayer.volume * 100;
            updateVolumeIcon(videoPlayer.volume, videoPlayer.muted);
        });

        videoPlayer.addEventListener('timeupdate', () => {
            // Ch·ªâ c·∫≠p nh·∫≠t progress bar n·∫øu ƒëang d√πng custom controls
            if (!videoPlayer.controls) {
                const progressBar = document.getElementById('progressBar');
                const timeDisplay = document.getElementById('timeDisplay');
                if (document.activeElement !== progressBar) {
                    progressBar.value = videoPlayer.currentTime;
                }
                
                // C·∫≠p nh·∫≠t th·ªùi gian hi·ªÉn th·ªã (CH·ªà HI·ªÇN TH·ªä TH·ªúI GIAN)
                timeDisplay.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
            }
        });

        document.getElementById('progressBar').addEventListener('input', () => {
            if (!videoPlayer.controls && !isNaN(videoPlayer.duration) && videoPlayer.duration > 0) {
                videoPlayer.currentTime = document.getElementById('progressBar').value;
            }
            showControls(); 
        });
        
        
        // Kh·ªüi t·∫°o menu t·ªëc ƒë·ªô v√† Tooltips
        setupSpeedMenu();
        setupTooltips();

        // ƒê·∫£m b·∫£o r·∫±ng URL object b·ªã thu h·ªìi khi trang b·ªã ƒë√≥ng
        window.addEventListener('beforeunload', () => {
            if (currentFileURL) {
                URL.revokeObjectURL(currentFileURL);
            }
        });
        
        // --- PWA LAUNCHQUEUE LOGIC (Gi·ªØ nguy√™n) ---
        if ('launchQueue' in window) {
            console.log('[File Handler] API supported. Setting consumer... (PWA)');
            window.launchQueue.setConsumer(async (launchParams) => {
                if (launchParams.files && launchParams.files.length > 0) {
                    console.log('[File Handler] File(s) received.');
                    
                    const fileHandle = launchParams.files[0];
                    
                    try {
                        // C·ªë g·∫Øng xin quy·ªÅn readwrite
                        const permissionStatus = await fileHandle.queryPermission({ mode: 'readwrite' });
                        if (permissionStatus !== 'granted') {
                             await fileHandle.requestPermission({ mode: 'readwrite' });
                        }

                        currentFileHandle = fileHandle; // L∆∞u File Handle
                        const file = await fileHandle.getFile();
                        
                        loadVideoFromFile(file);
                        // CH·ªà C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI V√Ä T√äN FILE
                        currentVideoInfo.textContent = `üé¨ ƒêang m·ªü file qua desktop: ${file.name}`;
                    } catch (error) {
                        console.error('L·ªói khi truy c·∫≠p File Handle:', error);
                        // N·∫øu OS m·ªü file nh∆∞ng kh√¥ng c·∫•p quy·ªÅn, ta v·∫´n c√≥ file obj ƒë·ªÉ load
                        try {
                            const file = await fileHandle.getFile();
                            currentFileHandle = null; // V·∫´n load nh∆∞ng kh√¥ng c√≥ quy·ªÅn Share/Write
                            loadVideoFromFile(file);
                            // CH·ªà C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI V√Ä T√äN FILE
                            currentVideoInfo.textContent = `‚ö†Ô∏è M·ªü file th√†nh c√¥ng: ${file.name}`;
                        } catch (readError) {
                            console.error('L·ªói khi ƒë·ªçc file sau khi th·∫•t b·∫°i readwrite:', readError);
                            currentFileHandle = null;
                            currentVideoInfo.textContent = 'üö´ L·ªói khi c·ªë g·∫Øng m·ªü file.';
                        }
                    }
                    updateShareButtonState(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i Share button
                } else {
                    console.log('[File Handler] App launched without files.');
                    currentFileHandle = null; // Reset
                    updateShareButtonState(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i Share button
                    currentVideoInfo.textContent = '·ª®ng d·ª•ng ƒë√£ kh·ªüi ƒë·ªông. K√©o & Th·∫£ video ƒë·ªÉ ph√°t!';
                }
            });
        } else {
            console.log('[File Handler] API not supported or PWA not installed.');
        }

        // --- SERVICE WORKER REGISTRATION (Gi·ªØ nguy√™n) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker: ƒêƒÉng k√Ω th√†nh c√¥ng v·ªõi scope:', reg.scope))
                    .catch(err => console.error('Service Worker: ƒêƒÉng k√Ω th·∫•t b·∫°i:', err));
            });
        }
    </script>
</body>
</html>
